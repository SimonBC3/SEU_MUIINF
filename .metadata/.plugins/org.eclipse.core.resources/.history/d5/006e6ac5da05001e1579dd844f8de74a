/*
 * HW.c
 *
 *  Created on: May 17, 2023
 *      Author: sbrot
 */

#include "HW.h"

// Global variables

void put_leds(uint8_t dato)
{

	if (dato & 0x01)
		HAL_GPIO_WritePin(GPIOB, LED1_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(GPIOB, LED1_Pin, GPIO_PIN_RESET);

	if (dato & 0x02)
		HAL_GPIO_WritePin(GPIOB, LED2_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(GPIOB, LED2_Pin, GPIO_PIN_RESET);
	if (dato & 0x04)
		HAL_GPIO_WritePin(GPIOA, LED3_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(GPIOA, LED3_Pin, GPIO_PIN_RESET);
	if (dato & 0x08)
		HAL_GPIO_WritePin(GPIOB, LED4_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(GPIOB, LED4_Pin, GPIO_PIN_RESET);
	if (dato & 0x10)
		HAL_GPIO_WritePin(GPIOB, LED5_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(GPIOB, LED5_Pin, GPIO_PIN_RESET);
	if (dato & 0x20)
		HAL_GPIO_WritePin(LED6_GPIO_Port, LED6_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(LED6_GPIO_Port, LED6_Pin, GPIO_PIN_RESET);
	if (dato & 0x40)
		HAL_GPIO_WritePin(GPIOB, LED7_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(GPIOB, LED7_Pin, GPIO_PIN_RESET);
	if (dato & 0x80)
		HAL_GPIO_WritePin(GPIOA, LED8_Pin, GPIO_PIN_SET);
	else
		HAL_GPIO_WritePin(GPIOA, LED8_Pin, GPIO_PIN_RESET);
	if (dato == 0)
	{
		put_leds(1);
		HAL_GPIO_WritePin(GPIOB, LED1_Pin, GPIO_PIN_RESET);
	}
}

void pot_leds(float value)
{
	if (value <= (3.3 / 8))
	{
		put_leds(1);
	}
	else if (value <= (3.3 * 2 / 8))
	{
		put_leds(3);
	}
	else if (value <= (3.3 * 3 / 8))
	{
		put_leds(7);
	}
	else if (value <= (3.3 * 4 / 8))
	{
		put_leds(15);
	}
	else if (value <= (3.3 * 5 / 8))
	{
		put_leds(63);
	}
	else if (value <= (3.3 * 6 / 8))
	{
		put_leds(127);
	}
	else if (value <= (3.3 * 7 / 8))
	{
		put_leds(255);
	}
}

uint32_t ConvertidorA_D(uint8_t channel)
{
	uint32_t valueAD;
	ADC_ChannelConfTypeDef sConfig;
	switch (channel)
	{
	case 0:
		// sensor de luz
		sConfig.Channel = ADC_CHANNEL_0;
		sConfig.Rank = 1;
		sConfig.SamplingTime = ADC_SAMPLETIME_3CYCLES;
		break;
	case 1:
		// sensor de temp
		sConfig.Channel = ADC_CHANNEL_1;
		sConfig.Rank = 1;
		sConfig.SamplingTime = ADC_SAMPLETIME_3CYCLES;
		break;
	case 4:
		// POT
		sConfig.Channel = ADC_CHANNEL_4;
		sConfig.Rank = 1;
		sConfig.SamplingTime = ADC_SAMPLETIME_3CYCLES;
		break;
	}
	HAL_ADC_ConfigChannel(&hadc1, &sConfig);

	HAL_ADC_Start(&hadc1);
	HAL_ADC_PollForConversion(&hadc1, 10000);
	valueAD = HAL_ADC_GetValue(&hadc1);
	return valueAD;
}

void setOffAlarm(float value, float trigger)
{
	if (value > trigger)
	{
		HAL_GPIO_WritePin(GPIOA, BUZZER_Pin, GPIO_PIN_SET);
	}
}

void turnOnLedsLight(float value)
{
	float div = 3.3 / 8;
	if (value <= div)
	{
		put_leds(1);
	}
	else if (value <= div * 2)
	{
		put_leds(3);
	}
	else if (value <= div * 3)
	{
		put_leds(7);
	}
	else if (value <= div * 4)
	{
		put_leds(15);
	}
	else if (value <= div * 5)
	{
		put_leds(31);
	}
	else if (value <= div * 6)
	{
		put_leds(63);
	}
	else if (value <= div * 7)
	{
		put_leds(127);
	}
	else
	{
		put_leds(255);
	}
}

void turnOnLedsTemp(float initValue, float currentValue)
{
	float div = 0.04;
	printf(" div value %.2f\n", (initValue + (div * 2)));
	if (currentValue <= (initValue + div))
	{
		put_leds(1);
	}
	else if (currentValue <= (initValue + (div * 2)))
	{
		put_leds(3);
	}
	else if (currentValue <= (initValue + (div * 3)))
	{
		put_leds(7);
	}
	else if (currentValue <= (initValue + (div * 4)))
	{
		put_leds(15);
	}
	else if (currentValue <= (initValue + (div * 5)))
	{
		put_leds(31);
	}
	else if (currentValue <= (initValue + (div * 6)))
	{
		put_leds(63);
	}
	else if (currentValue <= (initValue + (div * 7)))
	{
		put_leds(127);
	}
	else
	{
		put_leds(255);
	}
}

void lightSensorBehaviour()
{
	float lastPot = 0;
	float trigger = 0;

	uint32_t valueADLum = ConvertidorA_D(0);
	float valueBigLum = 4096 - valueADLum;
	float lumValue = (valueBigLum * 3.3) / 4095;
	printf("Value de la luz %.2f \r\n", lumValue);
	turnOnLedsLight(lumValue);

	// set trigger
	uint32_t valuePot = ConvertidorA_D(4);
	float currentPot = ((valuePot * 3.3) / 4095.0);
	printf("Value del pot %.2f \r\n", currentPot);
	if (currentPot > (lastPot + 0.35) || currentPot < (lastPot - 0.35))
	{
		printf("pot changed %.2f\r\n", currentPot);
		lastPot = currentPot;
		trigger = currentPot;
		for (int i = 0; i < 8; i++)
		{
			turnOnLedsLight(currentPot);
			for (int j = 0; j < 1000000; j++)
			{
			}
			put_leds(0);
			for (int j = 0; j < 1000000; j++)
			{
			}
		}
	}
	setOffAlarm(lumValue, trigger);
}

void tempSensorBehaviour()
{
	uint32_t tempInit = 0;
	float initTempValue = 0;
	float trigger = 0;

	uint32_t valueADTemp = ConvertidorA_D(1);
	float valueBigTemp = 4096 - valueADTemp;
	float tempValue = (valueBigTemp * 3.3) / 4095;
	// float resis = ((3.3*10000)/((3.3-valueBigTemp)/(4095*3.3)))-10000;
	printf("Value de la temp %.2f \r\n Value init temp %.2f \n", tempValue, initTempValue);
	// printf("Value de la resis %.2f \r\n", resis);
	turnOnLedsTemp(initTempValue, tempValue);

	// adjust leds maxvalue - minvalue and set leds according to the currentValue
	setOffAlarm(tempValue, trigger);
}

void restartAlarm()
{
	GPIO_PinState rightButtonState = GPIO_PIN_SET;
	GPIO_PinState rbCurrentState = HAL_GPIO_ReadPin(PULSADOR1_GPIO_Port, PULSADOR1_Pin);
	if (rightButtonState != rbCurrentState && rbCurrentState == GPIO_PIN_RESET)
	{
		rightButtonState = GPIO_PIN_RESET;
		HAL_GPIO_WritePin(GPIOA, BUZZER_Pin, GPIO_PIN_RESET);
		for (int j = 0; j < 70000000; j++)
		{
		}
	}

	if (rightButtonState != rbCurrentState && rbCurrentState == GPIO_PIN_SET)
	{
		rightButtonState = GPIO_PIN_SET;
	}
}

void initializeVars()
{
	uint32_t valuePot = ConvertidorA_D(4);
	float lastPot = ((valuePot * 3.3) / 4095.0);
	uint32_t tempInit = ConvertidorA_D(1);
	float initTempValue = ((4096 - tempInit) * 3.3) / 4095;
	float trigger = lastPot;
}

void runHW()
{
	GPIO_PinState leftButtonStatePrev = GPIO_PIN_SET;
	GPIO_PinState rightButtonState = GPIO_PIN_SET;

	uint32_t valuePot = 0;
	float lastPot = 0;
	uint32_t tempInit = 0;
	float initTempValue = 0;
	float trigger = ConvertidorA_D(0);
	float sensorValue = 0; //0 NTC || 1 LDR

	printf("runing HW \r\n");
	while(1) {
		//Check sensor change
		GPIO_PinState leftButtonCurrentState = HAL_GPIO_ReadPin(PULSADOR2_GPIO_Port, PULSADOR2_Pin);
		if (leftButtonStatePrev != GPIO_PIN_RESET && leftButtonCurrentState == GPIO_PIN_RESET)
		{
			leftButtonStatePrev = GPIO_PIN_RESET;
		}

		if (leftButtonStatePrev == GPIO_PIN_SET && leftButtonCurrentState == GPIO_PIN_SET)
		{
			printf("Button pressed \r\n");
			leftButtonStatePrev = GPIO_PIN_SET;
			if (sensorValue == 0)
			{
				printf("changing to NTC\r\n");
				return 1;
			}
			else
			{
				printf("changing to LDR\r\n");
				return 0;
			}
		}


		lightSensorBehaviour();
		tempSensorBehaviour();
		restartAlarm();
	}
}
